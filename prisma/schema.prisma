// Prisma Schema pour SaaS Agents IA
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ==================== USERS & AUTH ====================

model User {
  id            String         @id @default(cuid())
  email         String         @unique
  name          String?
  password      String?
  image         String?
  emailVerified DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Relations
  conversations Conversation[]

  @@map("users")
}

// ==================== AGENTS IA ====================

model Agent {
  id              String         @id @default(cuid())
  agentId         String         @unique  // 'comptable', 'reseaux-sociaux', etc.
  name            String
  icon            String
  description     String
  domain          String
  category        String
  welcomeMessage  String
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  conversations   Conversation[]
  workflows       Workflow[]

  @@map("agents")
}

// ==================== CONVERSATIONS ====================

model Conversation {
  id          String    @id @default(cuid())
  title       String
  userId      String?
  agentId     String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user        User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  agent       Agent     @relation(fields: [agentId], references: [agentId], onDelete: Cascade)
  messages    Message[]

  @@index([userId])
  @@index([agentId])
  @@map("conversations")
}

// ==================== MESSAGES ====================

model Message {
  id             String       @id @default(cuid())
  conversationId String
  role           String       // 'user' ou 'agent'
  content        String
  metadata       Json?        // Pour stocker infos suppl√©mentaires
  createdAt      DateTime     @default(now())

  // Relations
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("messages")
}

// ==================== WORKFLOWS N8N ====================

model Workflow {
  id          String    @id @default(cuid())
  n8nId       String?   @unique  // ID du workflow dans n8n
  agentId     String
  name        String
  description String?
  webhookUrl  String?
  isActive    Boolean   @default(false)
  config      Json?     // Configuration du workflow
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  agent       Agent     @relation(fields: [agentId], references: [agentId], onDelete: Cascade)
  executions  WorkflowExecution[]

  @@index([agentId])
  @@map("workflows")
}

// ==================== EXECUTIONS ====================

model WorkflowExecution {
  id          String    @id @default(cuid())
  workflowId  String
  status      String    // 'success', 'error', 'running'
  input       Json?
  output      Json?
  error       String?
  duration    Int?      // en ms
  createdAt   DateTime  @default(now())

  // Relations
  workflow    Workflow  @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([status])
  @@map("workflow_executions")
}
